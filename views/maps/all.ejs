
<h3>Global Map Explore</h3>
<div id="map"></div>
<script>
    function initMap() {
        var ironhack = { lat: 41.3977243, lng: 2.1905750999999998 };

        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 18,
            center: ironhack
        });

        var postMarkers = [];

        function bindInfoWindow(marker, map, infowindow, html) {
            marker.addListener('click', function () {
                infowindow.setContent(html);
                infowindow.open(map, this);
            });

            // Event that closes the Info Window with a click on the map
            google.maps.event.addListener(map, 'click', function () {
                infowindow.close();
            });
            //extra CODE to delete

            google.maps.event.addListener(infowindow, 'domready', function () {

                var iwOuter = $('.gm-style-iw');
                var iwBackground = iwOuter.prev();
                iwBackground.children(':nth-child(2)').css({ 'display': 'none' });

                // Removes white background DIV
                iwBackground.children(':nth-child(4)').css({ 'display': 'none' });

                // Moves the infowindow 115px to the right.
                iwOuter.parent().parent().css({ left: '115px' });

                // Moves the shadow of the arrow 76px to the left margin.
                iwBackground.children(':nth-child(1)').attr('style', function (i, s) { return s + 'left: 76px !important;' });

                // Moves the arrow 76px to the left margin.
                iwBackground.children(':nth-child(3)').attr('style', function (i, s) { return s + 'left: 76px !important;' });

                // Changes the desired tail shadow color.
                iwBackground.children(':nth-child(3)').find('div').children().css({ 'box-shadow': 'rgba(72, 181, 233, 0.6) 0px 1px 6px', 'z-index': '1' });

                // Reference to the div that groups the close button elements.
                var iwCloseBtn = iwOuter.next();

                // Apply the desired effect to the close button
                iwCloseBtn.css({ opacity: '1', right: '38px', top: '3px', border: '7px solid #48b5e9', 'border-radius': '13px', 'box-shadow': '0 0 5px #3990B9' });

                // If the content of infowindow not exceed the set maximum height, then the gradient is removed.
                if ($('.iw-content').height() < 140) {
                    $('.iw-bottom-gradient').css({ display: 'none' });
                }

                // The API automatically applies 0.7 opacity to the button after the mouseout event. This function reverses this event to the desired value.
                iwCloseBtn.mouseout(function () {
                    $(this).css({ opacity: '1' });
                });
            });
        }

        // disabling linter because we're templating code
        /*eslint-disable */

        <% posts.forEach((post, index) => { %>
            // <%= userHash[post.user_id].username %>
            // <%= userHash[post.user_id].name %>
            var position = {
                lat: <%=post.location.latitude %>,
                lng:  <%=post.location.longitude %>
            };

            var marker = new google.maps.Marker({
                position: position,
                map: map
            });

            marker.setIcon(({
                url: '../images/map-marker-photo.png',
                size: new google.maps.Size(50, 50),
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(17, 34),
                scaledSize: new google.maps.Size(50, 50)
            }));

            var contentString =`   
                <a href="/add/new/<%= post.id %>">
                    <div id="iw-container">
                        <div class="iw-title"><%= post.title %></div> 
                        <div class="iw-content">
                            <div class="iw-subTitle"><%= userHash[post.user_id].name %></div>
                            <img src="<%= post.picture.pic_path %>" alt="post photo here" height="115" width="83">
                            <p>  <%= post.content %>  </p>
                            <div class="iw-subTitle">Contacts</div>
                            <p><%= userHash[post.user_id].email %> 
                    </div>
                </a>
                <div class="iw-bottom-gradient"></div> 
                </div>`;

            var infowindow = new google.maps.InfoWindow({
                content: contentString,
                maxWidth: 350
            });

            // marker.addListener('click', function () {
            //     infowindow.open(map, marker);
            //     // window.location.href = `/add/new/<%=post._id%>`;
            // });

            bindInfoWindow(marker, map, infowindow, contentString);

            postMarkers.push(marker);

        <% }); %>

        /*eslint-enable */
        // let markerCluster = new MarkerClusterer(map, postMarkers,
        //     {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m' });


        let mapstyle = [{
            url: 'https://googlemaps.github.io/js-marker-clusterer/images/m1.png',
            height: 53,
            width: 52,
            anchor: [-18, 0],
            textColor: '#ffffff',
            textSize: 10,
            iconAnchor: [15, 48]
        }];

        markerClusterer = new MarkerClusterer(map, postMarkers, {
            maxZoom: 18,
            gridSize: 40,
            styles: mapstyle,
            imagePath: '../images/m'
        });

        google.maps.event.addListener(markerClusterer, 'clusterclick', function (cluster) {
            map.setCenter(cluster.getCenter());
            map.setZoom(map.getZoom() + 1);
        });

        google.maps.event.addDomListener(window, 'load', initialize);

    }

</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDbnybcbBy1raUOu9YsNd5QqNz0WBP_M-k&callback=initMap">
</script>
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
</script>
